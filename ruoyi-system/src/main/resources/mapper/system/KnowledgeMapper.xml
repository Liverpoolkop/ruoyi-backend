<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.KnowledgeMapper">

    <resultMap type="Knowledge" id="KnowledgeResult">
        <id property="knowledgeId" column="knowledge_id"/>
        <result property="knowledgeName" column="knowledge_name"/>
        <result property="knowledgeCode" column="knowledge_code"/>
        <result property="chapterId" column="chapter_id"/>
        <result property="courseId" column="course_id"/>
        <result property="content" column="content"/>
        <result property="difficultyLevel" column="difficulty_level"/>
        <result property="keywords" column="keywords"/>
        <result property="parentId" column="parent_id"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
        <result property="chapterName" column="chapter_name"/>
        <result property="courseName" column="course_name"/>
        <result property="parentName" column="parent_name"/>
    </resultMap>

    <sql id="selectKnowledgeVo">
        select k.knowledge_id, k.knowledge_name, k.knowledge_code, k.chapter_id, k.course_id,
               k.content, k.difficulty_level, k.keywords, k.parent_id,  k.status,
               k.create_time, k.update_time, k.remark,
               c.chapter_name, co.course_name,
               pk.knowledge_name as parent_name
        from edu_knowledge k
                 left join edu_chapter c on k.chapter_id = c.chapter_id
                 left join edu_course co on k.course_id = co.course_id
                 left join edu_knowledge pk on k.parent_id = pk.knowledge_id
    </sql>

    <select id="selectKnowledgeList" parameterType="Knowledge" resultMap="KnowledgeResult">
        <include refid="selectKnowledgeVo"/>
        <where>
            <if test="knowledgeName != null and knowledgeName != ''">
                AND k.knowledge_name like concat('%', #{knowledgeName}, '%')
            </if>
            <if test="courseId != null">
                AND k.course_id = #{courseId}
            </if>
            <if test="chapterId != null">
                AND k.chapter_id = #{chapterId}
            </if>
            <if test="difficultyLevel != null and difficultyLevel != ''">
                AND k.difficulty_level = #{difficultyLevel}
            </if>
            <if test="status != null and status != ''">
                AND k.status = #{status}
            </if>
            <if test="keywords != null and keywords != ''">
                AND k.keywords like concat('%', #{keywords}, '%')
            </if>
        </where>
        order by k.create_time desc
    </select>

    <select id="selectKnowledgeById" parameterType="Long" resultMap="KnowledgeResult">
        <include refid="selectKnowledgeVo"/>
        where k.knowledge_id = #{knowledgeId}
    </select>

    <select id="searchKnowledge" parameterType="String" resultMap="KnowledgeResult">
        <include refid="selectKnowledgeVo"/>
        where k.knowledge_name like #{keyword}
        or k.content like #{keyword}
        or k.keywords like #{keyword}
        order by k.create_time desc
    </select>

    <select id="selectKnowledgeByCourseId" parameterType="Long" resultMap="KnowledgeResult">
        <include refid="selectKnowledgeVo"/>
        where k.course_id = #{courseId} and k.status = '0'
        order by k.create_time
    </select>

    <insert id="insertKnowledge" parameterType="Knowledge" useGeneratedKeys="true" keyProperty="knowledgeId">
        insert into edu_knowledge (
        <if test="knowledgeName != null and knowledgeName != ''">knowledge_name,</if>
        <if test="knowledgeCode != null">knowledge_code,</if>
        <if test="chapterId != null">chapter_id,</if>
        <if test="courseId != null">course_id,</if>
        <if test="content != null">content,</if>
        <if test="difficultyLevel != null and difficultyLevel != ''">difficulty_level,</if>
        <if test="keywords != null">keywords,</if>
        <if test="parentId != null">parent_id,</if>
        <if test="status != null">status,</if>
        <if test="remark != null">remark,</if>
        create_time
        ) values (
        <if test="knowledgeName != null and knowledgeName != ''">#{knowledgeName},</if>
        <if test="knowledgeCode != null">#{knowledgeCode},</if>
        <if test="chapterId != null">#{chapterId},</if>
        <if test="courseId != null">#{courseId},</if>
        <if test="content != null">#{content},</if>
        <if test="difficultyLevel != null and difficultyLevel != ''">#{difficultyLevel},</if>
        <if test="keywords != null">#{keywords},</if>
        <if test="parentId != null">#{parentId},</if>
        <if test="status != null">#{status},</if>
        <if test="remark != null">#{remark},</if>
        sysdate()
        )
    </insert>

    <update id="updateKnowledge" parameterType="Knowledge">
        update edu_knowledge
        <set>
            <if test="knowledgeName != null and knowledgeName != ''">knowledge_name = #{knowledgeName},</if>
            <if test="knowledgeCode != null">knowledge_code = #{knowledgeCode},</if>
            <if test="chapterId != null">chapter_id = #{chapterId},</if>
            <if test="courseId != null">course_id = #{courseId},</if>
            <if test="content != null">content = #{content},</if>
            <if test="difficultyLevel != null and difficultyLevel != ''">difficulty_level = #{difficultyLevel},</if>
            <if test="keywords != null">keywords = #{keywords},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </set>
        where knowledge_id = #{knowledgeId}
    </update>

    <delete id="deleteKnowledgeById" parameterType="Long">
        delete from edu_knowledge where knowledge_id = #{knowledgeId}
    </delete>

    <delete id="deleteKnowledgeByIds" parameterType="Long">
        delete from edu_knowledge where knowledge_id in
        <foreach item="knowledgeId" collection="array" open="(" separator="," close=")">
            #{knowledgeId}
        </foreach>
    </delete>
</mapper>